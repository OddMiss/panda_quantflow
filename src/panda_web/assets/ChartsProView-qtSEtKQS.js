var k=Object.defineProperty;var D=(l,c,u)=>c in l?k(l,c,{enumerable:!0,configurable:!0,writable:!0,value:u}):l[c]=u;var y=(l,c,u)=>D(l,typeof c!="symbol"?c+"":c,u);import{Q as I}from"./klinecharts-pro-8tx7OSqM.js";import{d as A,r as _,f as $,c as b,o as v,_ as C}from"./main-XMHeTX60.js";const P=A({__name:"ChartsProView",setup(l){const c=_();$(()=>{c.value&&new I({container:c.value,symbol:{exchange:"DCE",market:"stocks",name:"pp2509",shortName:"pp2509",ticker:"pp2509",priceCurrency:"usd",type:"future"},period:{multiplier:15,timespan:"minute",text:"1m"},datafeed:new u("Q0aVaOIdjbaHHu5UZM5MQ0XcOEU3mSIJ")}).setTheme("dark")});class u{constructor(o){y(this,"_apiKey");this._apiKey=o}async searchSymbols(o){try{const t=await fetch("/pandaApi/instrumentInfoData/getQuotation");if(!t.ok)return console.error(`API 请求失败: ${t.status} ${t.statusText}`),[];const s=await t.json();if(console.log("API 返回结果:",s),s.code!=="200"||!s.data)return console.error("API 返回错误:",s.message),[];const e=Object.values(s.data);console.log(`获取到 ${e.length} 个合约`);let n=e;if(o&&o.trim()){const a=o.toLowerCase();n=e.filter(r=>r.code&&r.code.toLowerCase().includes(a)),console.log(`搜索 "${o}" 匹配到 ${n.length} 个合约`)}return n.map(a=>({ticker:a.code||"",name:a.underlyingSymbol||a.code||"",shortName:a.code||"",exchange:a.exchange||"",market:"futures",pricePrecision:2,volumePrecision:0,priceCurrency:"CNY",type:"future"}))}catch(t){return console.error("搜索代码时发生错误:",t),[]}}async getHistoryKLineData(o,t,s,e){return console.log("getHistoryKLineData",o,t,s,e),await((await(await fetch(`/pandaApi/historyData/queryHistoryData?startDate=${s}&endDate=${e}&symbol=${o.ticker}&period=${t.text}&quotationType=future`)).json()).data||[]).map(r=>({timestamp:t.text==="1d"?new Date(r.date.slice(0,4)+"-"+r.date.slice(4,6)+"-"+r.date.slice(6,8)).getTime():new Date(r.date).getTime(),open:r.open,high:r.high,low:r.low,close:r.close,volume:r.volume,turnover:r.volume}))}async getOrderFlowData(o){try{console.log(`📡 调用PandaAI订单流API: ${o.ticker}`);const t={symbolCode:o.ticker||"SA509",cycle:1,baseBarCount:1e4};console.log("📤 请求参数:",t);let s=localStorage.getItem("token");s="eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ1aWQiOiI0In0.m_uYVVkN6saALnHY9OyU6WIVNfLmku0Q_0lCX6DKNfTbezBJUSMqiDtTvXAnxGC1cNpeDKIkSlCh_GcIH3F5MRUbYNwmUCF_ZANYIP0vZbp6CUIOuGR9wiKtsjo5BAv4ecczMf2SsCWyBxOQN0K7h4yhSR6iVpyV5MkM0SLsDGCI0VnwbLFEANjgFGi-Hz_RICd_SIAIQxBtwPgOzeowEgnoKILpFs7xvOao3GDpJqo7GmeLmTzzilpH8udWo74SyEfxYewRodjkPi2VOdlTiWaX1qMv16seX0JKhJsuDk88eEMIJcjg9Y5G29hDzjef2z89Yjjyi_0dxh9Rla_Xsw";const e=await fetch("/pandaApi/orderFlow/getHistoryMarketData",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`${s}`},body:JSON.stringify(t)});if(!e.ok)throw new Error(`API请求失败: ${e.status} ${e.statusText}`);const n=await e.json();if(console.log("📥 API返回数据:",n),n.code!=="200")throw new Error(`API返回错误: ${n.code} - ${n.message}`);const a=this.convertPandaApiDataToOrderFlow(n.data,o);return console.log(`✅ 转换完成，共${a.length}条订单流数据`),a}catch(t){return console.error("❌ 获取订单流数据失败:",t),console.warn("🔄 使用模拟数据作为降级方案"),this.generateMockOrderFlowData(o)}}convertPandaApiDataToOrderFlow(o,t){if(!o||!o.baseBar||!Array.isArray(o.baseBar))return console.warn("⚠️ API数据格式不正确，使用模拟数据"),this.generateMockOrderFlowData(t);const s=[];for(const e of o.baseBar)try{const n=this.parseTickTime(e.ticktime),a=[],r=e.price||[],p=e.Ask||[],h=e.Bid||[];console.log(`📊 处理Bar数据: 时间=${e.ticktime}, 价格档位=${r.length}`);for(let i=0;i<r.length;i++){const m=r[i],w=p[i]||0,g=h[i]||0;m&&(w>0||g>0)&&a.push({price:Number(m.toFixed(2)),buyVolume:g,sellVolume:w,totalVolume:g+w})}a.sort((i,m)=>i.price-m.price);const d={timestamp:n,priceLevels:a,tickSize:.5,open:e.open,high:e.high,low:e.low,close:e.close,volume:e.volume,delta:e.delta};s.push(d),console.log(`✅ 转换Bar数据成功: 价格档位=${a.length}, Delta=${e.delta}`)}catch(n){console.error("❌ 转换单个Bar数据失败:",n,e)}return s}parseTickTime(o){try{if(!o)return Date.now();const t=new Date(o);return isNaN(t.getTime())?(console.warn(`⚠️ 无法解析时间格式: ${o}，使用当前时间`),Date.now()):t.getTime()}catch(t){return console.error("❌ 时间解析失败:",t,o),Date.now()}}generateMockOrderFlowData(o){console.log(`🔄 生成 ${o.ticker} 的模拟订单流数据`);const t=[],s=Date.now()-5*24*60*60*1e3;for(let e=100;e>=0;e--){const n=s-e*60*1e3,a=100+Math.random()*20,r=[];for(let p=0;p<10;p++){const h=a+(p-5)*.1,d=Math.floor(Math.random()*1e3),i=Math.floor(Math.random()*1e3);r.push({price:Number(h.toFixed(2)),buyVolume:d,sellVolume:i,totalVolume:d+i})}t.push({timestamp:n,priceLevels:r,tickSize:.01})}return console.log("mockData",t),t}}return(f,o)=>(v(),b("div",{ref_key:"containerRef",ref:c,id:"container",class:"chart-container"},null,512))}}),x=C(P,[["__scopeId","data-v-827a0e9c"]]);export{x as default};
